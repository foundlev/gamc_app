const initialNotams = [
  {
    "EST": false,
    "PERM": true,
    "ai_ac_type": "",
    "ai_category": "Weather Services",
    "ai_interpretation": "MET and flight information within the designated area is provided to departing and arriving aircraft through ATIS, VOLMET, and ATS units via radio communication upon crew request.",
    "ai_interpretation_role": "Pilot, Flight Dispatcher, ATC",
    "ai_main_category": "WEATHER",
    "ai_short_interpretation": "Additional information regarding transmission of MET and flight info.",
    "ai_timing": null,
    "ai_timing_ranges": null,
    "all": "$17",
    "enddate": "2100-01-01T00:00:00+00:00",
    "has_active_range": true,
    "icao": "UIAA",
    "issuedate": "2023-11-14T05:27:00+00:00",
    "key": "UIAA_A6723/23",
    "location": "UIAA",
    "message": "REF AIP PAGE 2.1 UIAA-17 ADDITIONAL INFO,\nPOINT 2 TRANSMISSION OF INFO, TEXT ADDED:\nMET AND FLIGHT INFO WI AD AREA PROVIDED TO DEP AND ARR ACFT\nBY ATIS, VOLMET AND ATS UNITS RADIO COM ON CREW REQ.\nMET...",
    "notam_id": "4SCW3gCfEOt57460RARQm0",
    "processed_at": "2024-11-25T15:30:11.765563",
    "raw_id": "A6723/23",
    "snowtam": {
      "ai_decoded": null,
      "decoded": null
    },
    "source_snowtam": false,
    "startdate": "2023-11-14T05:15:00+00:00",
    "sunrise_sunset_info": null,
    "timing_info": null
  },
  {
    "EST": false,
    "PERM": false,
    "ai_ac_type": "",
    "ai_category": "Taxiway Operations",
    "ai_interpretation": "Taxiway 5 is closed from February 26, 2025, at 04:19 to May 26, 2025, at 21:00.",
    "ai_interpretation_role": "Pilot, Flight Dispatcher, ATC",
    "ai_main_category": "AERODROME",
    "ai_short_interpretation": "Taxiway 5 closed",
    "ai_timing": null,
    "ai_timing_ranges": null,
    "all": "A1083/25 NOTAMR A8175/24\nQ) UIII/QMXLC/IV/M/A/000/999/5202N11318E005\nA) UIAA B) 2502260419 C) 2505262100\nE) TWY 5 CLSD.",
    "enddate": "2025-05-26T21:00:00+00:00",
    "has_active_range": true,
    "icao": "UIAA",
    "issuedate": "2025-02-26T04:36:00+00:00",
    "key": "UIAA_A1083/25",
    "location": "UIAA",
    "message": "TWY 5 CLSD.",
    "notam_id": "2Y1KfefiGhhKjvehY4jUFq",
    "processed_at": "2025-02-26T06:02:38.127233+00:00",
    "raw_id": "A1083/25",
    "snowtam": {
      "ai_decoded": null,
      "decoded": null
    },
    "source_snowtam": false,
    "startdate": "2025-02-26T04:19:00+00:00",
    "sunrise_sunset_info": null,
    "timing_info": null
  },
  {
    "EST": false,
    "PERM": false,
    "ai_ac_type": "Fourth class aircraft, Helicopters",
    "ai_category": "Runway Operations",
    "ai_interpretation": "Runway 11 is under maintenance with REDL and RTHL unserviceable. Aircraft landing during nighttime is prohibited, while landing is allowed during daytime only for fourth class aircraft and helicopters by VFR. Aircraft takeoff is allowed during both day and night.",
    "ai_interpretation_role": "Pilot, Flight Dispatcher",
    "ai_main_category": "AERODROME",
    "ai_short_interpretation": "Runway 11 restrictions",
    "ai_timing": null,
    "ai_timing_ranges": null,
    "all": "A1084/25 NOTAMR A8177/24\nQ) UIII/QFAXX/IV/NBO/A/000/999/5202N11318E005\nA) UIAA B) 2502260423 C) 2505262100\nE) RWY 11: REDL, RTHL U/S.\nRWY 11: ACFT LDG DRG NIGHTTIME PROHIBITED.\nRWY 11: LDG ALLOWED DRG DAYTIME ONLY FOR FOURTH CLASS ACFT AND HEL\nBY VFR.\nRWY 11: ACFT TKOF ALLOWED DRG DAY, NIGHT.",
    "enddate": "2025-05-26T21:00:00+00:00",
    "has_active_range": true,
    "icao": "UIAA",
    "issuedate": "2025-02-26T04:37:00+00:00",
    "key": "UIAA_A1084/25",
    "location": "UIAA",
    "message": "RWY 11: REDL, RTHL U/S.\nRWY 11: ACFT LDG DRG NIGHTTIME PROHIBITED.\nRWY 11: LDG ALLOWED DRG DAYTIME ONLY FOR FOURTH CLASS ACFT AND HEL\nBY VFR.\nRWY 11: ACFT TKOF ALLOWED DRG DAY, NIGHT.",
    "notam_id": "61PW3fzOJnAZ2pfj9eQhVU",
    "processed_at": "2025-02-26T06:02:38.127332+00:00",
    "raw_id": "A1084/25",
    "snowtam": {
      "ai_decoded": null,
      "decoded": null
    },
    "source_snowtam": false,
    "startdate": "2025-02-26T04:23:00+00:00",
    "sunrise_sunset_info": null,
    "timing_info": null
  },
  {
    "EST": false,
    "PERM": false,
    "ai_ac_type": "",
    "ai_category": "Fire and Rescue Services",
    "ai_interpretation": "The airport is operational 24 hours a day and has category 7 fire fighting services provided.",
    "ai_interpretation_role": "Pilot, Flight Dispatcher",
    "ai_main_category": "AERODROME",
    "ai_short_interpretation": "Airport operation hours H24 and CAT 7 for fire fighting available.",
    "ai_timing": null,
    "ai_timing_ranges": null,
    "all": "A1109/25 NOTAMR A0586/25\nQ) UIII/QFAAH/IV/NBO/A/000/999/5202N11318E005\nA) UIAA B) 2502270438 C) 2503312100\nE) AD OPR HR: H24.\nAD CAT 7 FOR FIRE FIGHTING PROVIDED.",
    "enddate": "2025-03-31T21:00:00+00:00",
    "has_active_range": true,
    "icao": "UIAA",
    "issuedate": "2025-02-27T04:42:00+00:00",
    "key": "UIAA_A1109/25",
    "location": "UIAA",
    "message": "AD OPR HR: H24.\nAD CAT 7 FOR FIRE FIGHTING PROVIDED.",
    "notam_id": "0c7BNGCmyobzCoToWmrSWp",
    "processed_at": "2025-02-27T06:02:46.501943+00:00",
    "raw_id": "A1109/25",
    "snowtam": {
      "ai_decoded": null,
      "decoded": null
    },
    "source_snowtam": false,
    "startdate": "2025-02-27T04:38:00+00:00",
    "sunrise_sunset_info": null,
    "timing_info": null
  }
]

// Находим кнопку и модалку для NOTAM
const notamBtn = document.getElementById('notamBtn');
const notamModalBackdrop = document.getElementById('notamModalBackdrop');
const closeNotamModalBtn = document.getElementById('closeNotamModalBtn');
const notamContent = document.getElementById('notamContent');

// Когда нажимаем кнопку "NOTAM", показываем модалку
function showNotamModal() {
    if (!nowIcao) {
        alert('Сначала выберите аэродром');
        return;
    }
    // Фильтруем из initialNotams только нужные
    // смотрите, у вас ключи могут быть "icao" или "location", используйте одинаково
    const notamsForIcao = initialNotams.filter(n => n.icao === nowIcao || n.location === nowIcao);

    if (notamsForIcao.length === 0) {
        notamContent.innerHTML = `Нет NOTAMов для <b>${nowIcao}</b>`;
    } else {
        let html = '';

        notamsForIcao.forEach(n => {
            const cat = getCategoryAppearance(n.ai_category);
            html += `
                <div class="notam-item">
                    <div class="notam-header">
                        <div class="notam-id-badge">
                            <i class="fas fa-file-alt notam-doc-icon"></i>
                            <span class="notam-id">${n.raw_id}</span>
                        </div>
                        <div class="notam-category" data-category="${n.ai_category}" style="background: ${cat.background}; color: ${cat.color};">
                            <i class="${cat.icon}" style="color: ${cat.color};"></i>
                            ${n.ai_category}
                        </div>
                    </div>
                    
                    <div class="notam-short-info">
                        <i class="fa-solid fa-circle-info"></i>
                        ${n.ai_short_interpretation}
                    </div>
        
                    ${n.ai_interpretation ? `
                    <div class="notam-interpretation">
                        ${n.ai_interpretation}
                    </div>
                    ` : ''}
        
                    <div class="notam-raw">${n.all.replace(/\n/g, '<br>')}</div>
        
                    <div class="notam-meta">
                        <span class="notam-period">
                            <i class="fas fa-calendar-alt"></i>
                            ${formatUTCDate(n.startdate)} - 
                            ${n.PERM ? 'Постоянный' : formatUTCDate(n.enddate)}
                        </span>
                        <span>
                            <i class="fas fa-clock"></i>
                            Выпущен: ${formatUTCDate(n.issuedate)}
                        </span>
                    </div>
                </div>
            `;
        });

        notamContent.innerHTML = html;
    }

    notamModalBackdrop.classList.add('show');
}

function getCategoryAppearance(category) {
    const categories = {
        'Fire and Rescue Services': {
            icon: 'fas fa-fire-extinguisher',
            background: 'var(--col-fire)',
            color: '#fff'
        },
        'Weather Services': {
            icon: 'fas fa-cloud-sun',
            background: 'var(--col-rf)', // Используем синий оттенок
            color: '#fff'
        },
        'Runway Operations': {
            icon: 'fas fa-plane-departure',
            background: 'var(--col-special)',
            color: '#fff'
        },
        'Taxiway Operations': {
            icon: 'fas fa-road',
            background: 'var(--col-operating)',
            color: '#fff'
        },
        'Apron Operations': {
            icon: 'fas fa-square-parking',
            background: 'var(--col-airspace)',
            color: '#000'
        },
        'Airport Maintenance': {
            icon: 'fas fa-toolbox',
            background: 'var(--col-instrument)',
            color: '#fff'
        },
        'Airspace Restrictions': {
            icon: 'fas fa-ban',
            background: 'var(--col-airspace)',
            color: '#fff'
        },
        'Navigation Aid Status': {
            icon: 'fas fa-satellite-dish',
            background: 'var(--col-instrument)',
            color: '#fff'
        },
        'ATS Communication': {
            icon: 'fas fa-tower-broadcast',
            background: 'var(--col-special)',
            color: '#fff'
        },
        'Flight Procedures': {
            icon: 'fas fa-map-signs',
            background: 'var(--col-approach)',
            color: '#fff'
        },
        'UAS/Drone Operations': {
            icon: 'fas fa-drone',
            background: 'var(--col-operating)',
            color: '#fff'
        },
        'Construction Activity': {
            icon: 'fas fa-hard-hat',
            background: 'var(--col-crane)',
            color: '#fff'
        },
        'Helicopter Operations': {
            icon: 'fas fa-helicopter',
            background: 'var(--col-security)',
            color: '#fff'
        },
        'Publication Updates': {
            icon: 'fas fa-book-open',
            background: 'var(--col-rf)',
            color: '#fff'
        },
        'SNOWTAM': {
            icon: 'fas fa-snowflake',
            background: 'var(--col-approach)',
            color: '#fff'
        },
        'Charts': {
            icon: 'fas fa-map',
            background: 'var(--col-operating)',
            color: '#fff'
        },
        'Special Use Airspace': {
            icon: 'fas fa-radiation',
            background: 'var(--col-special)',
            color: '#fff'
        },
        'Instrument Landing Systems': {
            icon: 'fas fa-wave-square',
            background: 'var(--col-instrument)',
            color: '#fff'
        },
        'Approach Procedures': {
            icon: 'fas fa-plane-arrival',
            background: 'var(--col-approach)',
            color: '#fff'
        },
        'Security Measures': {
            icon: 'fas fa-shield-alt',
            background: 'var(--col-security)',
            color: '#fff'
        },
        'Radio Frequency Changes': {
            icon: 'fas fa-broadcast-tower',
            background: 'var(--col-rf)',
            color: '#fff'
        },
        'Operating Restrictions': {
            icon: 'fas fa-ban',
            background: 'var(--col-operating)',
            color: '#fff'
        },
        'Temporary Obstacles': {
            icon: 'fas fa-exclamation-triangle',
            background: 'var(--col-temporary)',
            color: '#fff'
        },
        'Crane Operations': {
            icon: 'fas fa-crane',
            background: 'var(--col-crane)',
            color: '#fff'
        },
        'Airspace Closure': {
            icon: 'fas fa-lock',
            background: 'var(--col-airspace)',
            color: '#fff'
        }
    };

    return categories[category] || {
        icon: 'fas fa-info-circle',
        background: 'var(--col-operating)',
        color: '#fff'
    };
}

function formatUTCDate(dateString) {
    if(!dateString) return 'N/A';

    const issuedDate = new Date(dateString);

    const utcHours = String(issuedDate.getUTCHours()).padStart(2, '0');
    const utcMinutes = String(issuedDate.getUTCMinutes()).padStart(2, '0');
    const utcDay = String(issuedDate.getUTCDate()).padStart(2, '0');
    const utcMonth = String(issuedDate.getUTCMonth() + 1).padStart(2, '0'); // Месяцы начинаются с 0
    const utcYear = String(issuedDate.getUTCFullYear()).slice(-2);

    return `${utcHours}:${utcMinutes} ${utcDay}.${utcMonth}.${utcYear}`;
}

// Закрываем окно NOTAM
closeNotamModalBtn.addEventListener('click', () => {
    notamModalBackdrop.classList.remove('show');
});

// Если хотите закрывать по клику на задний фон:
notamModalBackdrop.addEventListener('click', (e) => {
    if (e.target === notamModalBackdrop) {
        notamModalBackdrop.classList.remove('show');
    }
});